# Pricing Plan Restructuring Plan

## Overview
Remove the **trial** and **basic** plans, keeping only:
- **Free** - CRM only, 1000 credits
- **Starter** - $20/month, CRM + HR, 60000 credits
- **Professional** - $49/month, CRM + HR, 300000 credits
- **Enterprise** - $99/month, All apps, 1200000 credits

---

## Current vs Target State

### Current Plans (6)
| Plan | Price | Credits | Apps |
|------|-------|---------|------|
| free | $0 | 1,000 | CRM |
| trial | $0 | 1,000 | CRM |
| starter | $20 | 60,000 | CRM + HR |
| professional | $49 | 300,000 | CRM + HR |
| basic | unknown | 250,000 | CRM + HR |
| enterprise | $99 | 1,200,000 | All Apps |

### Target Plans (4)
| Plan | Price | Credits | Apps |
|------|-------|---------|------|
| free | $0 | 1,000 | CRM |
| starter | $20 | 60,000 | CRM + HR |
| professional | $49 | 300,000 | CRM + HR |
| enterprise | $99 | 1,200,000 | All Apps |

---

## Code Changes Required

### 1. Backend: permission-matrix.js

**Remove trial plan (lines 825-842):**
```javascript
// REMOVE THIS BLOCK:
trial: {
  applications: ['crm'],
  modules: {
    crm: ['leads', 'contacts', 'dashboard']
  },
  permissions: { ... },
  credits: {
    free: 1000,
    paid: 0,
    expiryDays: 30
  }
},
```

**Remove basic plan (lines 906-940):**
```javascript
// REMOVE THIS BLOCK:
basic: {
  applications: ['crm', 'hr'],
  modules: { ... },
  permissions: { ... },
  credits: {
    free: 250000,
    paid: 0,
    expiryDays: 365
  }
},
```

### 2. Backend: subscription-service.js

**Update plan hierarchy:**
Remove references to `trial` and `basic` from plan hierarchy array.

**Update getAvailablePlans():**
Ensure the method returns only 4 plans with correct pricing:
- Free: $0
- Starter: $20
- Professional: $49
- Enterprise: $99

### 3. Frontend Types

Update any TypeScript interfaces or constants that define plan types to remove `trial` and `basic`.

---

## Stripe Dashboard Configuration

### Step 1: Archive Old Products/Prices

1. **Log in to Stripe Dashboard** → https://dashboard.stripe.com

2. **Navigate to Products:**
   - Go to **Products** → View all products

3. **Archive Trial and Basic Products:**
   - Find products named "Trial" or "Basic"
   - Click on each product → Click **Archive** (not delete)
   - Reason: These plans are being discontinued

4. **Navigate to Prices:**
   - Go to **Developers** → **Prices**
   - Find all prices associated with trial/basic products
   - Note the Price IDs for reference

### Step 2: Create/Update Products for New Pricing

#### Product 1: Starter Plan
| Field | Value |
|-------|-------|
| Name | Starter |
| Description | CRM + HR with 60,000 annual credits |
| Pricing Model | Standard pricing |
| Amount | $20.00 |
| Currency | USD |
| Billing Period | Yearly |

**Price ID format:** `price_starter_yearly_xxx`

#### Product 2: Professional Plan
| Field | Value |
|-------|-------|
| Name | Professional |
| Description | CRM + HR with 300,000 annual credits |
| Pricing Model | Standard pricing |
| Amount | $49.00 |
| Currency | USD |
| Billing Period | Yearly |

**Price ID format:** `price_professional_yearly_xxx`

#### Product 3: Enterprise Plan
| Field | Value |
|-------|-------|
| Name | Enterprise |
| Description | All apps with 1,200,000 annual credits |
| Pricing Model | Standard pricing |
| Amount | $99.00 |
| Currency | USD |
| Billing Period | Yearly |

**Price ID format:** `price_enterprise_yearly_xxx`

### Step 3: Update Environment Variables

In `wrapper/backend/.env`:

```bash
# Current (remove):
# STRIPE_PRICE_ID_TRIAL=price_xxx
# STRIPE_PRICE_ID_BASIC=price_xxx

# Keep/Update:
STRIPE_PRICE_ID_STARTER=price_starter_yearly_xxx    # $20
STRIPE_PRICE_ID_PROFESSIONAL=price_professional_yearly_xxx  # $49
STRIPE_PRICE_ID_ENTERPRISE=price_enterprise_yearly_xxx      # $99
```

### Step 4: Update Webhook Configuration

1. **Go to Developers → Webhooks**
2. **Ensure webhook endpoint is configured** for:
   - `customer.subscription.created`
   - `customer.subscription.updated`
   - `customer.subscription.deleted`
   - `invoice.payment_succeeded`
   - `invoice.payment_failed`

3. **Verify webhook signature** is being validated in backend code

### Step 5: Update Customer Portal Settings

1. **Go to Settings → Customer Portal**
2. **Update allowed products:**
   - Remove Trial and Basic from available upgrades
   - Keep: Free, Starter, Professional, Enterprise
3. **Set default product** if applicable

### Step 6: Handle Existing Subscriptions

**For customers on Trial or Basic plans:**

| Scenario | Action |
|----------|--------|
| Active trial subscription | Notify customer before trial ends, offer upgrade to paid plan |
| Active basic subscription | Offer migration to Professional or Enterprise |

**Recommended communication:**
- Email customers 30 days before changes
- Offer discount for early upgrade
- Provide clear migration path

---

## Migration Script (Optional)

If you need to migrate existing users from trial/basic plans:

```javascript
// Pseudo-code for migration
const planMigration = {
  trial: 'free',      // Trial users become free users
  basic: 'professional'  // Basic users upgrade to Professional
};

async function migrateSubscriptions() {
  const users = await db.users.find({
    subscriptionPlan: { $in: ['trial', 'basic'] }
  });
  
  for (const user of users) {
    const newPlan = planMigration[user.subscriptionPlan];
    await updateUserPlan(user.id, newPlan);
    await sendMigrationEmail(user, newPlan);
  }
}
```

---

## Testing Checklist

- [ ] Frontend pricing page shows only 4 plans
- [ ] Backend returns correct plans from API
- [ ] Checkout flow works for each paid plan
- [ ] Webhooks handle new price IDs correctly
- [ ] Permission checks work for all 4 plans
- [ ] Upgrade/downgrade flows work correctly
- [ ] Customer portal shows correct options

---

## Rollback Plan

If issues arise:
1. Keep archived products in Stripe (don't delete)
2. Maintain old price IDs in environment variables temporarily
3. Use feature flags to toggle between old/new pricing
4. Reverse code changes if needed
